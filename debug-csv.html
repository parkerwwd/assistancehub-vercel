<!DOCTYPE html>
<html>
<head>
    <title>CSV Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .file-input { margin: 20px 0; }
        .results { margin-top: 20px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>CSV File Debug Tool</h1>
    <div class="file-input">
        <input type="file" id="csvFile" accept=".csv">
        <button onclick="analyzeCSV()">Analyze CSV</button>
    </div>
    <div id="results" class="results"></div>

    <script>
        // Parse CSV line properly handling quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Don't forget the last field
            result.push(current);
            
            return result;
        }

        async function analyzeCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());
            
            // Parse headers
            const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/^"|"$/g, ''));
            
            // Parse first few rows
            const sampleRows = [];
            for (let i = 1; i < Math.min(4, lines.length); i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = (values[index] || '').trim().replace(/^"|"$/g, '');
                });
                sampleRows.push(row);
            }

            // Check format
            const isLIHTC = headers.includes('hud_id') || headers.includes('project');
            const isCleanedLIHTC = headers.includes('hud_id') && headers.includes('name') && headers.includes('units_studio');

            // Display results
            const results = document.getElementById('results');
            results.innerHTML = `
                <h2>File Analysis Results</h2>
                <p><strong>File:</strong> ${file.name}</p>
                <p><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                <p><strong>Total Lines:</strong> ${lines.length}</p>
                <p><strong>Format Detection:</strong></p>
                <ul>
                    <li>Is LIHTC Format: <span class="${isLIHTC ? 'success' : 'error'}">${isLIHTC}</span></li>
                    <li>Is Cleaned LIHTC: <span class="${isCleanedLIHTC ? 'success' : 'error'}">${isCleanedLIHTC}</span></li>
                </ul>
                
                <h3>Headers (${headers.length} columns):</h3>
                <pre>${JSON.stringify(headers, null, 2)}</pre>
                
                <h3>Sample Rows:</h3>
                ${sampleRows.map((row, i) => `
                    <h4>Row ${i + 1}:</h4>
                    <pre>${JSON.stringify(row, null, 2)}</pre>
                `).join('')}
                
                <h3>Key Fields Check:</h3>
                <ul>
                    <li>Has 'name': <span class="${headers.includes('name') ? 'success' : 'error'}">${headers.includes('name')}</span></li>
                    <li>Has 'address': <span class="${headers.includes('address') ? 'success' : 'error'}">${headers.includes('address')}</span></li>
                    <li>Has 'hud_id': <span class="${headers.includes('hud_id') ? 'success' : 'error'}">${headers.includes('hud_id')}</span></li>
                    <li>Has 'project': <span class="${headers.includes('project') ? 'success' : 'error'}">${headers.includes('project')}</span></li>
                </ul>
            `;
        }
    </script>
</body>
</html> 